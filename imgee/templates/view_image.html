{% extends "layout.html" %}
{% from 'baseframe/forms.html' import rendersubmit %}
{% from 'baseframe/forms.html' import renderform %}

{% block extendedsidebar %}
  <div class="sidebar row">                
    <div class="span3 browse-img">
      <h5><a href="{{ g.user.profile_url }}">Browse your gallery</a></h5>
      {% for p in prev %}
        <div class="image-thumb">
          <a href="{{url_for('view_image', profile=profile.name, image=p.name)}}" title="view image">
            <img src="{{url_for('get_thumbnail', image=p.name)}}"/>
          </a>
        </div>
      {% endfor %}
        <div class="image-thumb">
          <a href="{{url_for('view_image', profile=profile.name, image=img.name)}}" title="view image">
            <img class="active" src="{{url_for('get_thumbnail', image=img.name)}}"/>
          </a>
        </div>
      {% for n in next %}
        <div class="image-thumb">
          <a href="{{url_for('view_image', profile=profile.name, image=n.name)}}" title="view image">
            <img src="{{url_for('get_thumbnail', image=n.name)}}"/>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %} 

{% block maincontent %}
  <section class="view-image">
    <div class="row">
      <div class="span9 image-display">
        {% set img_url= url_for('get_image', image=img.name) %}
        <div class="image-display-title">
          <div class="heading editable_title" id="{{img.name}}">{{img.title}}</div>
          <div class="btn-group">
            {% if prev %}
              {% set p = prev | last %}
              <a href="{{url_for('view_image', profile=profile.name, image=p.name)}}" class="btn"><i class="icon-chevron-left"></i></a>
            {% endif %}
            {% if next %}
              {% set n = next | first %}
              <a href="{{url_for('view_image', profile=profile.name, image=n.name)}}" class="btn"><i class="icon-chevron-right"></i></a>
            {% endif %}
          </div>  
        </div>              
        <div class="image-display-area">
          <!-- picturefill -->
          <div id="img" data-picture data-alt="{{ img.title }}">
            <div data-src="{{url_for('get_image', image=img.name)}}"></div>
            <div data-src="{{url_for('get_image', image=img.name)}}?size={% if img.width < 250 %}img.width{% else %}250{% endif %}" data-media="(min-width: 480px)"></div>
            <div data-src="{{url_for('get_image', image=img.name)}}?size={% if img.width < 400 %}img.width{% else %}400{% endif %}" data-media="(min-width: 768px)"></div>
            <div data-src="{{url_for('get_image', image=img.name)}}?size={% if img.width < 521 %}img.width{% else %}521{% endif %}" data-media="(min-width: 980px)"></div>
            <div data-src="{{url_for('get_image', image=img.name)}}?size={% if img.width < 650 %}img.width{% else %}650{% endif %}" data-media="(min-width: 1200px)"></div>
            <!-- Fallback content for non-JS browsers. Same img src as the initial, unqualified source element. -->
            <noscript>
              <img class="image" src="{{url_for('get_image', image=img.name)}}" alt="{{ img.title }}">
            </noscript>
          </div>
          <!-- //picturefill -->
        </div>
        <div class="aside">
          <div class="img-attr">
            <ul>
              <li>Uploaded at: <br /><em>{{ img.created_at }}</em></li>
              <li>Size: <br /><em>{{ (img.size/1024) | round(2) }} KB</em></li>
              <li>Aspect-ratio: <br /><em>{{ img.width }} x {{ img.height }} px</em></li>
              <li>
                <ul class="labels">
                  {% if img.labels %}     
                    <li>Labels:</li>
                    {% for label in img.labels %}
                      <li><span class="label">
                        <a href="{{url_for('show_label', profile=img.profile.name, label=label.name)}}">{{label.name}}</a>
                      </span></li>
                    {% endfor %}
                {% endif %}
                </ul>
              </li>
            </ul>
          </div>
          <div class="delete-button">
            <a class="btn btn-danger" href="{{url_for('delete_file', profile=profile.name, image=img.name)}}"><i class="icon-trash"></i>&nbsp;Delete image</a> 
          </div>
        </div>
      </div>
    </div><!-- /row -->

    <div class="row">
      <div class="span6">
        {% set img_url= url_for('get_image', image=img.name) %}
        <div class="block block-1">
          <div class="block-title"><i class="icon-tag"></i>&nbsp;&nbsp;Resize image</div>
          Link to <a href='{{img_url}}'>original image</a> | At a different size:
          <input id='img_width' placeholder="w" />X<input id='img_height' placeholder="h" />
          <a href='{{img_url}}' id='img_link'> here</a>.
          <br/>
        </div>
      </div><!-- /span6 -->
      <div class="span3">
        {% set action_url=url_for('manage_labels', image=img.name, profile=img.profile.name) %}
        <div class="block block-2">
          <div class="block-title"><i class="icon-tag"></i>&nbsp;&nbsp;Manage labels</div>
          <div>
            <form action='{{action_url}}' method='POST'>
              {{form.csrf_token()}}
              {{form.stored_file_id()}}
              {{form.labels(value=','.join(labels))}}
              {{rendersubmit([(None, "Submit", 'btn-primary')])}}
            </form>
          </div>
        </div>
      </div><!-- /span3 -->
    </div><!-- /row -->
  </section><!-- /view-image -->
{% endblock %}

{% block footerscripts %}
<script type="text/javascript" src="{{url_for('static', filename='js/jquery.jeditable.min.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/jquery.jeditable.min.js')}}"></script>
<script> var profile = '{{profile.name}}';</script>
<script>
  $('input#img_width').width(100);
  $('input#img_height').width(100);
  $('input#img_link').width(420);
  var file_url = "{{url_for('get_image', image=img.name)}}";
  $('input[id^="img_"]').change(function (){
      var url_with_size = file_url + '?size=' + $('input#img_width').val() + 'x' + ($('input#img_height').val() || '0');
      $('a#img_link').attr('href', url_with_size);
  });

   var existing_labels = [];
   {% for label in profile.labels %}
      existing_labels.push('{{label.name}}');
   {% endfor %}
   $('#labels').select2({
        tags: existing_labels
   });
</script>
{% endblock %}
